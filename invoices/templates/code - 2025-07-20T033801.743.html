{% extends 'base.html' %}
{% block content %}

<style>
    /* 
    =================================================================
    * Template: Exact Invoice Replica - Django Integrated
    * Version: 8.0
    * Description: The precise visual design integrated with dynamic Django template variables.
    * Print-Optimized to prevent clipping issues.
    =================================================================
    */

    /* ========== Base Styles ========== */
    @import url('https://fonts.googleapis.com/css2?family=Arial&display=swap');

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        /* Styles for screen view, can be overridden by your base.html */
        direction: rtl;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* ========== Page & Invoice Container (for Screen View) ========== */
    .page-container {
        width: 210mm; /* A4 width for screen representation */
        min-height: 297mm; /* A4 height */
        margin: 20px auto;
        background: white;
        padding: 10mm;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .invoice-container {
        font-size: 10pt;
        line-height: 1.4;
        color: #000;
    }

    /* ========== Print Controls (Hidden on Print) ========== */
    .print-button-wrapper {
        position: fixed; top: 10px; left: 10px; z-index: 1000;
    }
    .print-button {
        background: #007bff; color: white; border: none; padding: 8px 16px;
        border-radius: 4px; cursor: pointer; font-size: 12px;
    }
    .print-button:hover { background: #0056b3; }

    /* ========== Header Section ========== */
    .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    .header-section { flex: 1; }
    .header-right { text-align: right; }
    .header-right h3 { font-size: 11pt; font-weight: bold; }
    .header-right p { font-size: 9pt; }
    .header-center { flex: 0 0 auto; text-align: center; }
    .logo-s { font-family: 'Times New Roman', Times, serif; font-size: 60pt; font-weight: bold; line-height: 1; }
    .header-left { text-align: left; }
    .header-left h2 { font-size: 11pt; font-weight: bold; }
    .header-left p { font-size: 9pt; }

    /* ========== Invoice Title Bar ========== */
    .invoice-title-bar { text-align: center; font-size: 10pt; margin-bottom: 10px; }

    /* ========== Details Box ========== */
    .details-box {
        border: 2px solid #000;
        padding: 5px 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
    }
    .details-col { width: 48%; font-size: 10pt; }
    .details-col p { margin-bottom: 2px; }

    /* ========== Items Table ========== */
    .items-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    .items-table th, .items-table td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 10pt; }
    .items-table th { background-color: #dbe5f1; font-weight: bold; }
    .items-table .description-col { text-align: right; width: 40%; }

    /* ========== Summary Table ========== */
    .summary-container { width: 300px; float: left; margin-bottom: 15px; }
    .summary-table { width: 100%; border-collapse: collapse; }
    .summary-table td { border: 1px solid #000; padding: 4px; font-size: 10pt; text-align: center; }
    .summary-label { background-color: #dbe5f1; font-weight: bold; text-align: right; padding-right: 10px; width: 70%; }

    /* ========== Total in Words ========== */
    .total-words { clear: both; text-align: center; font-size: 11pt; color: #d10000; font-weight: bold; margin: 20px 0; padding-top: 10px; }

    /* ========== Signatures ========== */
    .signatures-container { margin-top: 20px; padding-top: 10px; border-top: 1px solid #000; display: flex; justify-content: space-around; }
    .signature-box { text-align: center; font-size: 11pt; }
    .signature-line { border-bottom: 1px dotted #000; margin-top: 40px; height: 1px; width: 200px; }

    /* ========== Footer ========== */
    .invoice-footer { margin-top: 30px; padding-top: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
    .bank-details { flex-grow: 1; display: flex; justify-content: flex-end; gap: 20px; font-size: 9pt; line-height: 1.5; }
    .bank-account { text-align: right; }
    .bank-account h4 { font-weight: bold; font-size: 10pt; }
    .qr-section { text-align: center; margin-left: 20px; }
    .qr-code img { width: 90px; height: 90px; border: 1px solid #000; margin: 0 auto 5px; }
    .print-info { font-size: 9pt; color: #000; }

    /* 
    =================================================================
    * OPTIMIZED PRINT STYLES
    =================================================================
    */
    @media print {
        @page {
            size: A4;
            margin: 0; /* Remove default printer margins */
        }

        body, html {
            background: white !important;
            margin: 0;
            padding: 0;
        }

        /* إخفاء العناصر غير المرغوبة في الطباعة */
        .no-print, .print-button-wrapper, .navbar, .card-header, .breadcrumb, footer:not(.invoice-footer) {
            display: none !important;
        }

        .page-container {
            width: 100%;
            min-height: initial;
            margin: 0;
            padding: 0;
            box-shadow: none;
        }

        .invoice-container {
            padding: 10mm; /* إنشاء هوامش آمنة حول المحتوى */
            width: 100%;
            box-sizing: border-box;
            page-break-inside: avoid;
        }

        .items-table th,
        .summary-label {
            background-color: #dbe5f1 !important;
        }
    }
</style>

<div class="container-xxl flex-grow-1 container-p-y">

    <!-- هذا الجزء لن يطبع بسبب الكلاس no-print -->
    <div class="row no-print">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ title|default:"تفاصيل الفاتورة" }}</h4>
                    <div>
                        {% if invoice.invoice_type == 'sales' %}
                            <a href="{% url 'edit_sales_invoice' invoice.id %}" class="btn btn-warning me-2 btn-sm">تعديل</a>
                        {% elif invoice.invoice_type == 'purchase' %}
                            <a href="{% url 'edit_purchase_invoice' invoice.id %}" class="btn btn-info me-2 btn-sm">تعديل</a>
                        {% elif invoice.invoice_type == 'sales_return' %}
                            <a href="{% url 'update_sales_return_invoice' invoice.id %}" class="btn btn-success me-2 btn-sm">تعديل</a>
                        {% endif %}
                        <button type="button" class="btn btn-primary btn-sm" onclick="window.print();">طباعة</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- حاوية الفاتورة التي ستطبع -->
    <div class="page-container">
        <div class="invoice-container">
            
            <!-- Header -->
            <div class="invoice-header">
                <div class="header-section header-right">
                    <h3>{{ invoice.company.name|default:"مؤسسة ستايلك ون للتجارة" }}</h3>
                    <h3>ستايل للاقمشة</h3> <!-- عنصر ثابت حسب التصميم -->
                    <p><strong>الرقم الضريبي:</strong> {{ invoice.company.vat_number|default:"311128669300003" }}</p>
                    <p>{{ invoice.company.address|default:"جدة - البلد - سوق البدو" }}</p>
                </div>
                <div class="header-section header-center">
                    <div class="logo-s">S</div> <!-- عنصر ثابت حسب التصميم -->
                </div>
                <div class="header-section header-left">
                    <!-- هذه البيانات ثابتة حسب التصميم، يمكنك ربطها بمتغيرات إذا كانت متوفرة -->
                    <h2>Stylikone for Trading est</h2>
                    <h2>Style Fabric</h2>
                    <p>VAT: {{ invoice.company.vat_number|default:"311128669300003" }}</p>
                    <p>Jeddah - Albado Market</p>
                </div>
            </div>

            <!-- Invoice Title Bar -->
            <div class="invoice-title-bar">
                فاتورة ضريبية / {{ invoice.payment_method|default:"نقدي" }} / عادية
            </div>

            <!-- Details -->
            <div class="details-box">
                                <div class="details-col" style="text-align: right;">

                    <p><strong>رقم الفاتورة:</strong> {{ invoice.invoice_number }}</p>
                    <p><strong>البائع:</strong></p> <!-- يمكنك إضافة متغير للبائع هنا إذا وجد -->
                    <p><strong>الرقم الضريبي:</strong> {{ invoice.customer.vat_number|default:"-" }}</p>
                </div>
                <div class="details-col" style="text-align: right;">
                    <p><strong>السادة:</strong> {{ invoice.customer.name|default:"-" }}</p>
                    <p><strong>التاريخ:</strong> {{ invoice.invoice_date|date:"d/m/Y" }}</p>
                    <p><strong>البيان:</strong> {{ invoice.notes|default:"-" }}</p> <!-- استخدام حقل الملاحظات للبيان -->
                </div>
            </div>

            <!-- Items Table -->
            <table class="items-table">
                <thead>
                    <tr>
                        <th>مسلسل</th>
                        <th class="description-col">البيان</th>
                        <th>ياردة</th> <!-- بيانات غير متوفرة في الموديل -->
                        <th>طاقة</th> <!-- بيانات غير متوفرة في الموديل -->
                        <th>الأفرادي</th>
                        <th>مبلغ الضريبة</th> <!-- بيانات غير متوفرة لكل بند -->
                        <th>الإجمالي</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.invoice_items.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td class="description-col">{{ item.product.serial_number|default:"" }} -- {{ item.product.name_ar|default:"-" }}</td>
                        <td></td> <!-- حقل فارغ لـ "ياردة" -->
                        <td style="text-align: center;">{{ item.quantity|floatformat:"0g" }}</td> <!-- استخدام الكمية كـ "طاقة" -->
                        <td style="text-align: center;">{{ item.unit_price|floatformat:2 }}</td>
                        <td></td> <!-- حقل فارغ لـ "مبلغ الضريبة" لكل بند -->
                        <td style="text-align: center;">{{ item.total|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center;">لا توجد بنود في هذه الفاتورة.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Summary -->
            <div class="summary-container">
                <table class="summary-table">
                    <tr>
                        <td class="summary-label">إجمالي الكمية</td>
                        <td>{{ invoice.total_quantity|default:"-" }}</td> <!-- افترضت وجود متغير total_quantity -->
                    </tr>
                    <tr>
                        <td class="summary-label">المجموع الجزئي فاتورة</td>
                        <td>{{ invoice.subtotal_before_tax|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td class="summary-label">ضريبة القيمة المضافة</td>
                        <td>{{ invoice.tax_amount|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td class="summary-label">الصافي</td>
                        <td>{{ invoice.total_amount|floatformat:2 }}</td>
                    </tr>
                </table>
            </div>

            <!-- Total in Words -->
            <div class="total-words">
                {{ total_words|default:"المبلغ كتابة غير متوفر" }}
            </div>

            <!-- Signatures -->
            <div class="signatures-container">
                <div class="signature-box">
                    اسم وتوقيع المستلم
                    <div class="signature-line"></div>
                </div>
                <div class="signature-box">
                    اعدت من قبل
                    <div class="signature-line"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="invoice-footer">
                <div class="qr-section">
                    <div class="qr-code">
                                    <img src="{% url 'generate_qr_code' invoice.id %}" alt="QR Code">
                    </div>
                    
                    <div class="print-info">
                        <span>PrintedOn: {% now "d/m/Y" %}</span>
                        <span>Time: {% now "H:i" %}</span>
                    </div>
                </div>
                <!-- تفاصيل البنك ثابتة كما في التصميم الأصلي -->
                <div class="bank-details">
                     <div class="bank-account">
                        <h4>البنك الاهلي</h4>
                        <p><strong>الاسم:</strong> مؤسسة حمد مسفر نجا الغامدي التجارية</p>
                        <p><strong>رقم الحساب:</strong> 01400014058607</p>
                    </div>
                    <div class="bank-account">
                        <h4>بنك الراجحي</h4>
                        <p><strong>الاسم:</strong> مؤسسة حمد مسفر نجا الغامدي التجارية</p>
                        <p><strong>رقم الحساب:</strong> 453608010477547</p>
                        <p><strong>رقم الايبان:</strong> SA9180000453608010477547</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}