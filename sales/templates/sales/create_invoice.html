{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  /* تنسيقات Tom Select المخصصة */
  .ts-control {
    padding: 0.375rem 0.75rem; /* مطابقة هوامش Bootstrap */
    line-height: 1.5;
    min-height: calc(1.5em + 0.75rem + 2px); /* مطابقة ارتفاع حقول Bootstrap */
    border-color: #ced4da; /* مطابقة لون حدود Bootstrap */
  }
  /* إصلاحات لـ Tom Select داخل input-group */
  .input-group .ts-wrapper.form-control {
      position: relative;
      flex: 1 1 auto;
      width: 1%;
      min-width: 0;
  }
  .ts-wrapper.form-control {
      border: none;
      box-shadow: none;
      padding: 0;
  }
  .table-responsive {
    overflow: visible !important; /* مهم لظهور القوائم المنسدلة بشكل صحيح */
    position: relative;
  }
  .ts-dropdown {
    position: absolute !important; /* ضمان ظهور القائمة فوق العناصر الأخرى */
    z-index: 9999 !important; /* قيمة z-index عالية */
  }
  /* التأكد من أن الـ Modal له z-index كافي */
  .modal {
    z-index: 1051 !important; /* أعلى قليلاً من z-index الافتراضي لـ Bootstrap dropdown */
  }
</style>

<!-- تضمين ملفات CSS الخارجية -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

<div class="container-xxl flex-grow-1 container-p-y">

  <!-- شريط التنقل العلوي (Breadcrumb) -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">المحاسبة</a></li>
      <li class="breadcrumb-item"><a href="#">فواتير المبيعات</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ title|default:"إنشاء فاتورة مبيعات" }}</li>
    </ol>
  </nav>

  <!-- عرض رسائل النظام (إذا وجدت) -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- الفورم الرئيسي لإنشاء الفاتورة -->
  <form id="invoiceForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="mb-0">
        فاتورة مبيعات
        <!-- شارة الحالة -->
        <span class="badge bg-warning ms-2" style="font-size: 0.8rem;">مسودة</span>
      </h3>
      <div>
        <button type="submit" class="btn btn-primary me-2">
          <i class="fas fa-save me-1"></i> حفظ
        </button>
        <a href="#" class="btn btn-secondary">
          <i class="fas fa-times me-1"></i> إلغاء
        </a>
      </div>
    </div>

    <!-- القسم العلوي: بيانات الفاتورة وملخص الحسابات -->
    <div class="row">
      <!-- بطاقة بيانات الفاتورة الأساسية -->
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-body">
            <!-- سطر الحقول الأول -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="{{ form.customer.id_for_label }}" class="form-label">العميل</label>
                <div class="input-group">
                    {{ form.customer }} {# سيتم تحويله إلى Tom Select #}
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#customerModal">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                {% if form.customer.errors %}<div class="invalid-feedback d-block">{{ form.customer.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label for="{{ form.invoice_number.id_for_label }}" class="form-label">رقم الفاتورة</label>
                {{ form.invoice_number }}
                {% if form.invoice_number.errors %}<div class="invalid-feedback d-block">{{ form.invoice_number.errors|striptags }}</div>{% endif %}
              </div>
            </div>

            <!-- سطر الحقول الثاني -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="{{ form.payment_method.id_for_label }}" class="form-label">طريقة الدفع</label>
                {{ form.payment_method }}
                 {% if form.payment_method.errors %}<div class="invalid-feedback d-block">{{ form.payment_method.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label for="{{ form.invoice_date.id_for_label }}" class="form-label">تاريخ الفاتورة</label>
                {{ form.invoice_date }}
                 {% if form.invoice_date.errors %}<div class="invalid-feedback d-block">{{ form.invoice_date.errors|striptags }}</div>{% endif %}
              </div>
            </div>

            <!-- سطر الحقول الثالث -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label for="{{ form.discount_percentage.id_for_label }}" class="form-label">نسبة الخصم (%)</label>
                {{ form.discount_percentage }}
                 {% if form.discount_percentage.errors %}<div class="invalid-feedback d-block">{{ form.discount_percentage.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label for="{{ form.notes.id_for_label }}" class="form-label">الملاحظات</label>
                {{ form.notes }}
                 {% if form.notes.errors %}<div class="invalid-feedback d-block">{{ form.notes.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label for="{{ form.status.id_for_label }}" class="form-label">حالة الفاتورة</label>
                {{ form.status }}
                 {% if form.status.errors %}<div class="invalid-feedback d-block">{{ form.status.errors|striptags }}</div>{% endif %}
              </div>
            </div>

            <!-- الحقول المالية المخفية -->
            {{ form.invoice_type }}
            {{ form.tax_rate.as_hidden }}
            {{ form.subtotal_before_discount.as_hidden }}
            {{ form.discount.as_hidden }}
            {{ form.subtotal_before_tax.as_hidden }}
            {{ form.tax_amount.as_hidden }}
            {{ form.total_amount.as_hidden }}
          </div>
        </div>
      </div>

      <!-- بطاقة ملخص الحسابات -->
      <div class="col-md-4">
        <div class="card mb-4 border-info">
          <div class="card-header bg-info text-white">
            ملخص الحسابات
          </div>
          <div class="card-body">
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <th>الإجمالي قبل الخصم</th>
                  <td id="total-value" class="text-end fw-bold">0.00 ر.س</td>
                </tr>
                <tr>
                  <th>قيمة الخصم</th>
                  <td id="discount-value" class="text-end text-danger">0.00 ر.س</td>
                </tr>
                <tr>
                  <th>الإجمالي بعد الخصم</th>
                  <td id="net-value" class="text-end fw-bold">0.00 ر.س</td>
                </tr>
                <tr>
                  <th>ضريبة ({{ form.tax_rate.value|default:"15" }}%)</th>
                  <td id="tax-value" class="text-end">0.00 ر.س</td>
                </tr>
                <tr class="bg-light">
                  <th class="fs-5">الصافي</th>
                  <td id="invoice-value" class="text-end fs-5 fw-bolder text-primary">0.00 ر.س</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- بطاقة عناصر الفاتورة (الجدول) -->
    <div class="card mb-4 border-secondary">
      <div class="card-header bg-secondary text-white">
        بنود الفاتورة
      </div>
      <div class="card-body">
        {{ formset.management_form }}
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 25%;">البيان (المنتج)</th>
                <th style="width: 15%;">ياردة (محسوب)</th> {# العمود الجديد لإظهار الطاقة بالوحدة الأساسية #}
                <th style="width: 10%;">الطاقة</th>
                <th style="width: 15%;">الوحدة</th>
                <th style="width: 15%;">الأفرادي (سعر الوحدة الأساسية)</th> {# تعديل الاسم للتوضيح #}
                <th style="width: 15%;">الإجمالي</th>
                <th style="width: 5%;" class="text-center">إجراء</th>
              </tr>
            </thead>
            <tbody id="invoice-items-tbody">
              {# عرض البنود الموجودة مسبقاً #}
              {% for item_form in formset %}
                <tr class="invoice-item">
                  {{ item_form.id }} {# ضروري لـ inline formsets #}
                  <td>
                      {{ item_form.product }} {# سيتم تحويله بواسطة Tom Select #}
                      {% if item_form.product.errors %}<div class="invalid-feedback d-block">{{ item_form.product.errors|striptags }}</div>{% endif %}
                  </td>
                  {# عرض الطاقة المحسوبة بالوحدة الأساسية #}
                  <td class="item-base-quantity text-end fw-bold">0.00</td>
                  <td>
                      {{ item_form.quantity }}
                      {% if item_form.quantity.errors %}<div class="invalid-feedback d-block">{{ item_form.quantity.errors|striptags }}</div>{% endif %}
                  </td>
                  <td>
                      {{ item_form.unit }} {# سيتم تحديث خياراته ديناميكياً #}
                      {% if item_form.unit.errors %}<div class="invalid-feedback d-block">{{ item_form.unit.errors|striptags }}</div>{% endif %}
                  </td>
                  <td>
                      {{ item_form.unit_price }} {# سعر الوحدة الأساسية #}
                      {% if item_form.unit_price.errors %}<div class="invalid-feedback d-block">{{ item_form.unit_price.errors|striptags }}</div>{% endif %}
                  </td>
                  {# إجمالي السطر = الطاقة المحسوبة بالياردة * سعر الأفرادي #}
                  <td class="item-total text-end fw-bold">0.00 ر.س</td>
                  <td class="text-center">
                    {{ item_form.DELETE }} {# خانة حذف البند #}
                    <button type="button" class="btn btn-danger btn-sm remove-item" title="حذف السطر">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- زر إضافة صف جديد -->
        <button id="add-row-button" type="button" class="btn btn-success mt-3">
          <i class="fas fa-plus me-1"></i> إضافة بند
        </button>

        <!-- قالب النموذج الفارغ لإضافة صفوف جديدة (مخفي) -->
        <table class="d-none">
          <tbody id="empty-form-template">
            <tr class="invoice-item">
              {{ formset.empty_form.id }} {# معرف النموذج الفارغ #}
              <td>
                  {{ formset.empty_form.product }} {# سيتم تهيئته كـ Tom Select #}
              </td>
              <td class="item-base-quantity text-end fw-bold">0.00</td> {# مكان عرض الطاقة المحسوبة #}
              <td>
                  {{ formset.empty_form.quantity }}
              </td>
              <td>
                  {{ formset.empty_form.unit }} {# سيتم ملؤه ديناميكياً #}
              </td>
              <td>
                  {{ formset.empty_form.unit_price }} {# سعر الوحدة الأساسية #}
              </td>
              <td class="item-total text-end fw-bold">0.00 ر.س</td> {# مكان عرض إجمالي السطر #}
              <td class="text-center">
                {{ formset.empty_form.DELETE }} {# خانة الحذف #}
                 <button type="button" class="btn btn-danger btn-sm remove-item" title="حذف السطر">
                   <i class="fas fa-trash-alt"></i>
                 </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </form>
</div>

<!-- Modal إضافة عميل (يمكنك استبدال المحتوى بنموذج إضافة العميل الخاص بك) -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalLabel">إضافة عميل جديد</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      {# استخدم فورماً منفصلاً لإضافة العميل #}
      <form id="customerForm" method="post" action="{% url 'add_customer' %}"> {# تأكد من أن 'add_customer' هو اسم الـ URL الصحيح #}
        {% csrf_token %}
        <div class="modal-body">
          {# عرض الأخطاء العامة لنموذج العميل إذا وجدت #}
          {% if customer_form.non_field_errors %}
            <div class="alert alert-danger">{{ customer_form.non_field_errors }}</div>
          {% endif %}

          <!-- حقول نموذج العميل -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="{{ customer_form.name.id_for_label }}" class="form-label">{{ customer_form.name.label }}</label>
              {{ customer_form.name }}
              {% if customer_form.name.errors %}<div class="invalid-feedback d-block">{{ customer_form.name.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ customer_form.phone.id_for_label }}" class="form-label">{{ customer_form.phone.label }}</label>
              {{ customer_form.phone }}
              {% if customer_form.phone.errors %}<div class="invalid-feedback d-block">{{ customer_form.phone.errors|striptags }}</div>{% endif %}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="{{ customer_form.email.id_for_label }}" class="form-label">{{ customer_form.email.label }}</label>
              {{ customer_form.email }}
              {% if customer_form.email.errors %}<div class="invalid-feedback d-block">{{ customer_form.email.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ customer_form.address_line.id_for_label }}" class="form-label">{{ customer_form.address_line.label }}</label>
              {{ customer_form.address_line }}
              {% if customer_form.address_line.errors %}<div class="invalid-feedback d-block">{{ customer_form.address_line.errors|striptags }}</div>{% endif %}
            </div>
          </div>
          <!-- ... أضف المزيد من حقول العميل حسب الحاجة ... -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="submit" class="btn btn-primary">حفظ العميل</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- تضمين ملف JavaScript الخاص بـ Tom Select -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. استلام بيانات المنتجات والوحدات والأسعار من Django View
    // تأكد من تمرير هذه المتغيرات في سياق Django context
    const productPrices = JSON.parse('{{ product_prices_json|escapejs }}');
    const productData = JSON.parse('{{ product_data_json|escapejs }}');

    const invoiceItemsTbody = document.getElementById('invoice-items-tbody');
    const mainInvoiceForm = document.getElementById('invoiceForm');

    // 2. وظائف مساعدة ومنطق الحساب
    // تهيئة Tom Select لأي حقل select للمنتجات
    function initializeProductSelect(element) {
        if (element && !element.tomselect) { // تجنب التهيئة المتكررة
            new TomSelect(element, {
                create: false, // لا تسمح بإنشاء منتجات جديدة من القائمة
                sortField: { field: "text", direction: "asc" }, // فرز أبجدي
                placeholder: "ابحث أو اختر منتج...",
                // يمكنك إضافة خيارات أخرى هنا إذا لزم الأمر
            });
        }
    }

    // تحديث خيارات الوحدات في حقل select بناءً على المنتج المختار
    function updateUnitOptions(row) {
        const productSelect = row.querySelector('select[name$="-product"]');
        const unitSelect = row.querySelector('select[name$="-unit"]');
        const productId = productSelect.value;

        // إزالة الخيارات الحالية
        while (unitSelect.options.length > 1) { // الاحتفاظ بالخيار الأول (إذا كان هناك placeholder)
            unitSelect.remove(1);
        }

        if (productId && productData[productId]) {
            const product = productData[productId];
            // إضافة الوحدة الأساسية
            if (product.base_unit) {
                const option = new Option(product.base_unit.name, product.base_unit.id);
                unitSelect.add(option);
            }
            // إضافة وحدات التحويل
            product.conversions.forEach(conv => {
                const option = new Option(conv.name, conv.id);
                unitSelect.add(option);
            });
        }
        // تحديث حسابات الصف بعد تغيير الوحدة
        updateRowCalculations(row);
    }

    // حساب كمية الياردة والإجمالي لكل صف
    function updateRowCalculations(row) {
        const productSelect = row.querySelector('select[name$="-product"]');
        const unitSelect = row.querySelector('select[name$="-unit"]');
        const quantityInput = row.querySelector('input[name$="-quantity"]');
        const unitPriceInput = row.querySelector('input[name$="-unit_price"]'); // سعر الوحدة الأساسية (الأفرادي)
        const baseQuantityCell = row.querySelector('.item-base-quantity');
        const itemTotalCell = row.querySelector('.item-total');

        const productId = productSelect.value;
        if (!productId) return;

        const basePrice = parseFloat(productPrices[productId] || 0); // سعر الياردة

        // تحديث سعر الأفرادي إذا لم يكن المستخدم يعدله حالياً
        if (document.activeElement !== unitPriceInput) {
            unitPriceInput.value = basePrice.toFixed(2);
        }

        const quantity = parseFloat(quantityInput.value) || 0; // الطاقة المدخلة (مثلاً: طاقات)

        let conversionFactor = 1.0;
        const selectedUnitId = unitSelect.value;
        if (selectedUnitId && productData[productId] && productData[productId].conversions) {
            // البحث عن عامل التحويل للوحدة المختارة
            const conv = productData[productId].conversions.find(c => c.id == selectedUnitId);
            if (conv) {
                conversionFactor = parseFloat(conv.factor);
            }
        }

        // حساب الطاقة بالوحدة الأساسية (الياردة)
        const calculatedBaseQuantity = quantity * conversionFactor;
        baseQuantityCell.textContent = calculatedBaseQuantity.toFixed(2);

        // حساب إجمالي السطر (الطاقة بالياردة * سعر الياردة)
        const priceToUse = parseFloat(unitPriceInput.value) || basePrice; // استخدام السعر المدخل أو السعر الأساسي
        const total = calculatedBaseQuantity * priceToUse;
        itemTotalCell.textContent = total.toFixed(2) + " ر.س";

        // تحديث الملخص العام للفاتورة
        updateInvoiceSummary();
    }

    // تحديث الملخص المالي للفاتورة بالكامل
    function updateInvoiceSummary() {
        let subtotal = 0;
        // حساب الإجمالي الفرعي لجميع البنود المرئية
        invoiceItemsTbody.querySelectorAll('tr.invoice-item:not([style*="display: none"])').forEach(row => {
            const totalText = row.querySelector('.item-total').textContent;
            subtotal += parseFloat(totalText) || 0;
        });

        // الحصول على الخصم والضريبة من الحقول الرئيسية
        const discountPercentage = parseFloat(mainInvoiceForm.querySelector('[name="discount_percentage"]').value) || 0;
        const taxRate = parseFloat(mainInvoiceForm.querySelector('[name="tax_rate"]').value) || 15; // القيمة الافتراضية 15%

        // حساب القيم المالية
        const discountValue = subtotal * (discountPercentage / 100);
        const subtotalAfterDiscount = subtotal - discountValue;
        const taxValue = subtotalAfterDiscount * (taxRate / 100);
        const finalTotal = subtotalAfterDiscount + taxValue;

        // تحديث عرض الملخص
        document.getElementById('total-value').textContent = subtotal.toFixed(2) + " ر.س";
        document.getElementById('discount-value').textContent = discountValue.toFixed(2) + " ر.س";
        document.getElementById('net-value').textContent = subtotalAfterDiscount.toFixed(2) + " ر.س";
        document.getElementById('tax-value').textContent = taxValue.toFixed(2) + " ر.س";
        document.getElementById('invoice-value').textContent = finalTotal.toFixed(2) + " ر.س";

        // تحديث الحقول المخفية لإرسالها مع الفورم
        mainInvoiceForm.querySelector('[name="subtotal_before_discount"]').value = subtotal.toFixed(2);
        mainInvoiceForm.querySelector('[name="discount"]').value = discountValue.toFixed(2);
        mainInvoiceForm.querySelector('[name="subtotal_before_tax"]').value = subtotalAfterDiscount.toFixed(2);
        mainInvoiceForm.querySelector('[name="tax_amount"]').value = taxValue.toFixed(2);
        mainInvoiceForm.querySelector('[name="total_amount"]').value = finalTotal.toFixed(2);
    }

    // 3. ربط الأحداث (Event Listeners)
    // استماع لتغييرات في حقول الصف (منتج، وحدة، كمية، سعر)
    invoiceItemsTbody.addEventListener('change', function(e) {
        const row = e.target.closest('tr.invoice-item');
        if (!row) return;
        // إذا تغير المنتج، قم بتحديث خيارات الوحدات
        if (e.target.matches('select[name$="-product"]')) {
            updateUnitOptions(row);
        }
        // إعادة حساب قيم الصف بعد أي تغيير
        updateRowCalculations(row);
    });

    // استماع لإدخال البيانات في حقول الطاقة والسعر
    invoiceItemsTbody.addEventListener('input', function(e) {
        const row = e.target.closest('tr.invoice-item');
        if (!row) return;
        // فقط الحقول التي تؤثر مباشرة على الحسابات
        if (e.target.matches('input[name$="-quantity"], input[name$="-unit_price"]')) {
            updateRowCalculations(row);
        }
    });

    // استماع لتغيير نسبة الخصم لتحديث الملخص العام
    mainInvoiceForm.querySelector('[name="discount_percentage"]').addEventListener('input', updateInvoiceSummary);

    // التعامل مع زر إضافة بند جديد
    document.getElementById("add-row-button").addEventListener("click", function() {
        const formsetPrefix = '{{ formset.prefix }}'; // اسم البادئة لـ formset (مثل 'form-')
        const totalFormsInput = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`); // حقل إدارة العدد الإجمالي للنماذج
        if (!totalFormsInput) {
            console.error("لم يتم العثور على حقل TOTAL_FORMS!");
            return;
        }
        let currentCount = parseInt(totalFormsInput.value);

        // الحصول على HTML النموذج الفارغ واستبدال '__prefix__' بالعدد الحالي
        const template = document.getElementById('empty-form-template').innerHTML.replace(/__prefix__/g, currentCount);

        // إضافة الصف الجديد إلى الجدول
        const newRow = invoiceItemsTbody.insertRow();
        newRow.innerHTML = template;
        newRow.classList.add("invoice-item"); // إضافة الكلاس للتعرف عليه

        // تهيئة Tom Select للمنتج في الصف الجديد
        const productSelectInNewRow = newRow.querySelector('select[name$="-product"]');
        if (productSelectInNewRow) {
            initializeProductSelect(productSelectInNewRow);
        }

        // زيادة العدد الإجمالي للنماذج
        totalFormsInput.value = currentCount + 1;
    });

    // التعامل مع زر حذف الصف (باستخدام تفويض الأحداث)
    invoiceItemsTbody.addEventListener('click', function(e) {
        const removeButton = e.target.closest('.remove-item');
        if (removeButton) {
            const row = removeButton.closest('tr.invoice-item');
            const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                // إذا كان البند موجوداً مسبقاً في قاعدة البيانات، فقط حدد خانة الحذف
                deleteCheckbox.checked = true;
                row.style.display = 'none'; // إخفاء الصف بصرياً
            } else {
                // إذا كان الصف مضافاً حديثاً ولم يتم حفظه بعد، قم بإزالته تماماً
                row.remove();
            }
            // إعادة حساب الملخص بعد حذف صف
            updateInvoiceSummary();
        }
    });

    // التعامل مع إضافة عميل جديد عبر Modal (AJAX)
    const customerForm = document.getElementById('customerForm');
    const customerModalElement = document.getElementById('customerModal');
    const mainCustomerSelect = document.getElementById('{{ form.customer.id_for_label }}');

    if (customerForm && customerModalElement && mainCustomerSelect) {
        customerForm.addEventListener('submit', function(e) {
            e.preventDefault(); // منع الإرسال التقليدي للفورم
            const formData = new FormData(this);

            fetch(this.action, { // استخدام عنوان URL الموجود في سمة action للفورم
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', // للإشارة إلى أن الطلب هو AJAX
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken') // إرسال CSRF token
                }
            })
            .then(response => response.json()) // تحويل الاستجابة إلى JSON
            .then(data => {
                if (data.success) {
                    // إضافة العميل الجديد إلى القائمة المنسدلة الرئيسية
                    const newOption = new Option(data.customer_name, data.customer_id, true, true); // النص، القيمة، افتراضياً لا تحدد، تحدد الآن
                    mainCustomerSelect.appendChild(newOption);
                    // mainCustomerSelect.value = data.customer_id; // تحديد الخيار الجديد تلقائياً

                    // إغلاق الـ Modal
                    const modal = bootstrap.Modal.getInstance(customerModalElement) || new bootstrap.Modal(customerModalElement);
                    modal.hide();

                    // إعادة تعيين الفورم داخل الـ Modal
                    this.reset();
                    // يمكنك إضافة منطق لمسح رسائل الخطأ السابقة هنا إذا كنت تعرضها بشكل ديناميكي

                } else {
                    // التعامل مع الأخطاء: عرضها للمستخدم
                    console.error('خطأ في إضافة العميل:', data.errors);
                    // مثال بسيط: عرض رسالة تنبيه
                    alert('حدث خطأ أثناء إضافة العميل:\n' + JSON.stringify(data.errors));
                    // يمكنك تحسين هذا بعرض الأخطاء بجوار الحقول المقابلة داخل الـ Modal
                }
            })
            .catch(error => {
                console.error('خطأ في الشبكة أو الخادم:', error);
                alert('حدث خطأ غير متوقع أثناء الاتصال بالخادم.');
            });
        });
    }

    // 4. التهيئة الأولية عند تحميل الصفحة
    // تهيئة Tom Select لجميع المنتجات الموجودة
    document.querySelectorAll('#invoice-items-tbody tr.invoice-item').forEach(row => {
        initializeProductSelect(row.querySelector('select[name$="-product"]'));
        // تحديث الوحدات والحسابات للبنود الموجودة مسبقاً
        updateUnitOptions(row);
        updateRowCalculations(row); // ضروري إذا كانت هناك قيم افتراضية أو بنود محفوظة
    });

    // إجراء الحسابات الأولية عند تحميل الصفحة
    updateInvoiceSummary();

    // تعيين التاريخ الحالي إذا كان الحقل فارغاً (اختياري)
    let dateInput = mainInvoiceForm.querySelector('input[type="datetime-local"][name="{{ form.invoice_date.html_name }}"]');
    if (dateInput && !dateInput.value) {
        let now = new Date();
        let year = now.getFullYear();
        let month = (now.getMonth() + 1).toString().padStart(2, '0');
        let day = now.getDate().toString().padStart(2, '0');
        let hours = now.getHours().toString().padStart(2, '0');
        let minutes = now.getMinutes().toString().padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

}); // نهاية DOMContentLoaded
</script>

{% endblock %}