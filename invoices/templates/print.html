{% extends 'base.html' %}
{% block content %}

<style>
    /* ========== أنماط الشاشة (Screen Styles) ========== */

    /* إعدادات الجسم العامة */
    body {
        /* هذه الأنماط تؤثر على العرض العادي في المتصفح */
        /* يمكنك إبقائها كما هي أو تعديلها حسب تصميم موقعك العام */
        font-family: 'Helvetica Neue', Arial, sans-serif; /* استخدام خط نظيف */
        direction: rtl;
        text-align: right;
        background-color: #f9f9f9; /* لون خلفية خفيف للعرض */
    }

    /* تغليف الفاتورة (للتوسيط والعرض على الشاشة) */
    .invoice-wrapper {
        display: flex;
        justify-content: center;
        padding: 30px 15px; /* هوامش حول الفاتورة على الشاشة */
        /* background-color: #e9e9e9; */ /* لإظهار حدود الحاوية */
    }

    /* حاوية الفاتورة الرئيسية (الشكل على الشاشة) */
    .invoice-container {
        width: 850px; /* عرض مقارب لـ A4 على الشاشات الكبيرة */
        max-width: 100%; /* لضمان الاستجابة للشاشات الأصغر */
        background-color: #fff;
        padding: 30px 40px; /* هوامش داخلية جيدة */
        border: 1px solid #ddd;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin: 0 auto; /* للتوسيط إذا لزم الأمر */
        font-size: 14px; /* حجم خط أساسي مناسب */
        line-height: 1.6;
    }

    /* إعدادات الجدول الأساسية */
    .table {
        width: 100%;
        border-collapse: collapse; /* لإزالة المسافات بين حدود الخلايا */
        margin-bottom: 15px !important; /* مسافة أسفل الجداول */
    }

    /* خلايا الجدول (بيانات وعناوين) */
    .table th, .table td {
        border: 1px solid #dee2e6; /* حدود خفيفة */
        padding: 8px 12px;       /* هوامش داخلية مريحة */
        text-align: right;       /* محاذاة للنص */
        vertical-align: top;    /* محاذاة للأعلى (جيد للنصوص الطويلة) */
    }

    .table th { /* تنسيق خاص لرأس الجدول */
        background-color: #f8f9fa; /* لون خلفية خفيف للرأس */
        font-weight: 600;         /* خط أثقل */
        font-size: 15px;
        border-bottom-width: 2px; /* خط أسمك أسفل الرأس */
        color: #0026ff;
    }
    .table .td { /* يمكن استخدامه لخلايا بيانات محددة إذا لزم الأمر */
         font-size: 14px;
    }
    .table .th td { /* يستخدم إذا كان صف الرأس يستخدم td بدلاً من th */
         font-weight: 600;
         font-size: 15px;
         color: #0026ff;
    }
    /* إزالة الحشو الزائد من خلايا الملخص */
    .small-summary-table td, .small-summary-table th {
        padding: 4px 8px 4px 8px !important;
        font-size: 12px;
    }

    /* تنسيق Header الفاتورة */
    .invoice-header-section {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px double #333; /* خط مزدوج للفصل */
    }
    .invoice-header-section h2 {
        margin-bottom: 5px;
        font-size: 20px;
        font-weight: bold;
    }
    .invoice-header-section .header-details p {
        margin: 2px 8px; /* تقليل الهوامش بين بيانات الشركة */
        display: inline-block; /* جعلها في سطر واحد قدر الإمكان */
        font-size: 13px;
    }

    /* عنوان الفاتورة */
    .invoice-title-section {
        text-align: center;
        margin-bottom: 25px;
    }
    /* تم إضافة الكلاس no-print-mobile لإخفاء العنوان في الطباعة على الهاتف */
    .invoice-title-section .main-title {
        font-size: 20px;
        font-weight: bold;
        color: #0026ff;
        margin-bottom: 8px;
    }
    .invoice-title-section .subtitle-box {
        display: inline-block;
        border: 2px solid #0026ff;
        padding: 5px 15px;
        font-size: 16px;
        font-weight: bold;
        color: #0026ff;
        border-radius: 8px;
    }

    /* زر الطباعة (للشاشة فقط) */
    .print-button {
        display: block; /* يجعله يأخذ السطر كاملاً افتراضياً */
        margin: 20px auto; /* للتوسيط */
        padding: 10px 25px;
        font-size: 16px;
        background-color: #0d6efd; /* أزرق Bootstrap */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .print-button:hover {
        background-color: #0b5ed7;
    }

    /* حاوية زر تعديل الفاتورة في اعلى الصفحة (لا تطبع) */
    .invoice-actions-header {
       /* أنماط للشاشة فقط إذا لزم الأمر */
    }

    /* تنسيقات التذييل (الشاشة والطباعة) */
    .invoice-footer {
        margin-top: 30px; /* مسافة فوق التذييل */
        padding-top: 15px;
        border-top: 3px double #333; /* خط مزدوج للفصل */
    }
    .invoice-footer table {
        width: 100%;
    }
    .footer-cell {
        width: 33.33%;
        text-align: center; /* توسيط المحتوى داخل كل خلية */
        vertical-align: top;
        padding: 5px 10px;
    }
    .footer-cell .line-wrapper {
        display: flex;
        align-items: center;
        justify-content: center; /* توسيط محتويات التوقيع */
        width: 85%; /* تحديد عرض نسبي */
        margin: 8px auto; /* هوامش أوتوماتيكية للتوسيط */
    }
    .footer-cell .label, .footer-cell .sub-label {
        white-space: nowrap; /* منع التفاف كلمة البائع/التوقيع */
        margin: 0 5px; /* هوامش حول النص */
        font-size: 13px;
        font-weight: 500;
    }
    .footer-cell .line {
        flex-grow: 1; /* جعل الخط يملأ المساحة المتبقية */
        border-bottom: 1px dashed #555;
        height: 1px;
    }
    .invoice-footer .qr img {
        max-width: 120px; /* حجم معقول للـ QR */
        height: auto;
        margin: 0 auto; /* للتوسيط */
        display: block;
    }

    /* ========== أنماط الطباعة (@media print) ========== */
    @media print {

        /* ----- إعدادات الصفحة العامة للطباعة ----- */
        @page {
            size: A4 portrait;  /* حجم الورق واتجاهه */
            margin: 15mm;       /* هوامش الطباعة (مثال: 1.5 سم من كل جهة) */
        }

        html, body {
            width: 100%;         /* استخدام عرض منطقة الطباعة */
            height: auto;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #fff !important; /* خلفية بيضاء دائما */
            font-size: 10pt;     /* حجم خط مناسب للطباعة (قد تحتاج لتعديله) */
            color: #000 !important; /* نص أسود دائما */
            -webkit-print-color-adjust: exact; /* محاولة فرض الألوان (مفيد للحدود والشعارات) */
            print-color-adjust: exact;
        }

        /* ----- إخفاء العناصر غير المرغوبة ----- */
        /* إخفاء الشريط العلوي، والأزرار، والتذييل العام، وأي عنصر لديه كلاس no-print */
        header, nav, aside, footer:not(.invoice-footer), .no-print, .print-button, .invoice-actions-header,
        .navbar, .card-header, .breadcrumb {
            display: none !important;
        }

        /* ----- التركيز على محتوى الفاتورة ----- */
        .invoice-wrapper {
             display: block; /* إلغاء flex */
             padding: 0 !important; /* إزالة أي حشو خارجي */
             margin: 0 !important;
        }

        .invoice-container {
            width: 100% !important;     /* تملأ منطقة الطباعة */
            max-width: 100% !important;
            border: none !important;      /* إزالة حدود الشاشة */
            box-shadow: none !important; /* إزالة ظلال الشاشة */
            padding: 0 !important;       /* إزالة الحشو الداخلي */
            margin: 0 !important;
            page-break-inside: avoid;
            position: static !important;
            visibility: visible !important;
        }

        /* ضمان ظهور جميع العناصر داخل الفاتورة */
        .invoice-container * {
             visibility: visible !important;
        }

         /* ----- تحسين الجداول للطباعة ----- */
        .table {
            margin-bottom: 10px !important;
        }
        .table th, .table td {
            padding: 5px 8px !important;
            font-size: 9pt;
            border: 1px solid #ccc !important;
        }
         .table th {
             background-color: #eee !important;
             color: #000 !important;
             -webkit-print-color-adjust: exact;
             print-color-adjust: exact;
         }

        /* ----- التحكم في فواصل الصفحات ----- */
        table, tr, img, .invoice-footer, .small-summary-table {
            page-break-inside: avoid !important;
        }
         .table thead {
            display: table-header-group !important;
         }
         .invoice-footer {
             page-break-before: auto !important;
         }

         /* ----- تنسيقات أخرى للطباعة ----- */
         a {
             color: inherit !important;
             text-decoration: none !important;
         }
         .logo-img {
            max-height: 40px !important;
            width: auto;
         }
         .invoice-footer .qr img {
            max-width: 90px !important;
         }
         
         /* ===== إخفاء التاريخ وعنوان الفاتورة على الهاتف ===== */
         @media print and (max-width: 768px) {
             .no-print-mobile {
                 display: block !important;
             }
         }
         .small-summary-table table,
    .small-summary-table table td {
        border: 1px solid #ccc !important; /* يمكنك استخدام #ccc أو #bbb أو #ddd حسب الرغبة */
    }

    }
</style>

<!-- ======================= محتوى HTML (لا حاجة لتغييرات كبيرة هنا) ======================= -->

<div class="container-xxl flex-grow-1 container-p-y">

    <!-- هذا الجزء لن يطبع بسبب الكلاس no-print -->
    <div class="row no-print">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center invoice-actions-header">
                    <h4 class="mb-0">{{ title|default:"تفاصيل الفاتورة" }}</h4>
                    <div>
                        {% if invoice.invoice_type == 'sales' %}
                            <a href="{% url 'edit_sales_invoice' invoice.id %}" class="btn btn-warning me-2 btn-sm">
                                <i class="fas fa-edit me-1"></i> تعديل مبيعات
                            </a>
                        {% elif invoice.invoice_type == 'purchase' %}
                            <a href="{% url 'edit_purchase_invoice' invoice.id %}" class="btn btn-info me-2 btn-sm">
                                <i class="fas fa-edit me-1"></i> تعديل مشتريات
                            </a>
                        {% elif invoice.invoice_type == 'sales_return' %}
                            <a href="{% url 'update_sales_return_invoice' invoice.id %}" class="btn btn-success me-2 btn-sm">
                                <i class="fas fa-edit me-1"></i> تعديل ائتمانات
                            </a>
                        {% else %}
                        {% endif %}

                        <!-- زر الطباعة -->
                        <button type="button" class="btn btn-primary btn-sm print-button" onclick="printInvoice();">
                           <i class="fas fa-print me-1"></i> طباعة الفاتورة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- حاوية الفاتورة التي ستطبع -->
    <div class="invoice-wrapper" dir="rtl">
        <div class="invoice-container">

            <!-- الجزء العلوي (بيانات الشركة) -->
            <div class="invoice-header-section">
                {% if invoice.company.name %}
                    <h2 style='color: #0026ff;'>{{ invoice.company.name }}</h2>

                {% endif %}
                <div class="header-details">
                    {% if invoice.company.address %}
                        <p >{{ invoice.company.address }}</p>
                    {% endif %}
                    {% if invoice.company.fax %}
                        <p>س ت: {{ invoice.company.fax }}</p>
                    {% endif %}
                    {% if invoice.company.phone %}
                        <p>هاتف: {{ invoice.company.phone }}</p>
                    {% endif %}
                                        {% if invoice.company.cr_number %}   <p>        رقم السجل التجاري : {{ invoice.company.cr_number }}</p>{% endif %}

                    {% if invoice.company.vat_number %}
                        <p>الرقم الضريبي: {{ invoice.company.vat_number }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- عنوان الفاتورة -->
            <div class="invoice-title-section">
                <!-- إضافة الكلاس no-print-mobile لإخفاء عنوان الفاتورة عند الطباعة على الهاتف -->
                <p class="main-title no-print-mobile">فاتورة ضريبية</p>
                <div class="subtitle-box">
                    {{ invoice.get_invoice_type_display }} {% if invoice.payment_method %}({{ invoice.payment_method }}){% endif %}
                </div>
            </div>

            <!-- معلومات العميل والفاتورة -->
            <table class="table" style="margin-bottom: 20px !important;">
                <tbody>
                    <tr>
                        <td class="td" style="width: 50%;"><strong>رقم العميل:</strong> {{ invoice.customer.customer_id|default:"458" }}</td>
                        <td class="td" style="width: 50%;"><strong>اسم العميل:</strong> {{ invoice.customer.name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <td class="td"><strong>الرقم الضريبي للعميل:</strong> {{ invoice.customer.vat_number|default:"-" }}</td>
                        <td class="td"><strong>رقم الفاتورة:</strong> {{ invoice.invoice_number }}</td>
                    </tr>
                    <tr>
                        <td class="td"><strong>عنوان العميل:</strong> {{ invoice.customer.address_line|default:"-" }}</td>
                        <!-- إضافة الكلاس no-print-mobile لإخفاء تاريخ الفاتورة عند الطباعة على الهاتف -->
                        <td class="td no-print-mobile"><strong>تاريخ الفاتورة:</strong> {{ invoice.invoice_date|date:"Y-m-d" }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- جدول البنود -->
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 5%;">م</th>
                        <th style="width: 15%;">رقم الصنف</th>
                        <th>الوصف</th>
                        <th style="width: 10%;">الكمية</th>
                        <th style="width: 15%;">السعر</th>
                        <th style="width: 15%;">الإجمالي</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.invoice_items.all %}
                    <tr>
                        <td class="td">{{ forloop.counter }}</td>
                        <td class="td">{{ item.product.serial_number|default:"-" }}</td>
                        <td class="td" style="text-align: right;">{{ item.product.name_ar|default:"-" }}</td>
                        <td class="td" style="text-align: center;">{{ item.quantity|floatformat:"0g" }}</td>
                        <td class="td" style="text-align: left;">{{ item.unit_price|floatformat:2 }}</td>
                        <td class="td" style="text-align: left;">{{ item.total|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td class="td" colspan="6" style="text-align: center;">لا توجد بنود في هذه الفاتورة.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- الملخص المالي (يأتي بعد جدول البنود مباشرة) -->
            <div style="clear: both;"></div>
            <div class="small-summary-table" style="float: left; width: 230px; margin-top: 15px;">
                 <table style="border: 1px solid #ddd;">
                     <tr>
                         <td style="width: 60%;">الإجمالي قبل الخصم</td>
                         <td style="width: 40%; text-align: left;">
                            {{ invoice.subtotal_before_discount|floatformat:2 }}
                         </td>
                     </tr>
                     <tr>
                         <td>الخصم</td>
                         <td style="text-align: left;">
                            {{ invoice.discount|floatformat:2 }}
                         </td>
                     </tr>
                     <tr>
                         <td>الإجمالي بعد الخصم</td>
                         <td style="text-align: left;">
                            {{ invoice.subtotal_before_tax|floatformat:2 }}
                         </td>
                     </tr>
                     <tr>
                         <td>ضريبة القيمة المضافة (15%)</td>
                         <td style="text-align: left;">
                             {{ invoice.tax_amount|floatformat:2 }}
                         </td>
                     </tr>
                     <tr style="font-weight: bold; background-color: #f8f9fa;">
                         <td>المبلغ المستحق</td>
                         <td style="text-align: left;">
                            {{ invoice.total_amount|floatformat:2 }}
                         </td>
                     </tr>
                 </table>
                 <!-- التفقيط -->
                  <div style="padding: 8px 12px; font-size: 13px; border-top: 1px solid #ddd;">
                      <strong>فقط:</strong> {{ total_words|default:"" }}
                  </div>
            </div>
            <div style="clear: both;"></div>

            <!-- قسم التذييل (Footer) -->
            <div class="invoice-footer">
                <table>
                    <tbody>
                        <tr>
                            <!-- العمود الأيمن (البائع) -->
                            <td class="footer-cell">
                                <div class="line-wrapper"><span class="label">البائع:</span><span class="line"></span></div>
                                <div class="line-wrapper"><span class="sub-label">التوقيع:</span><span class="line"></span></div>
                            </td>

                            <!-- العمود الأوسط (QR Code) -->
                            <td class="footer-cell qr">
                                
                                    <img src="{% url 'generate_qr_code' invoice.id %}" alt="QR Code">

                            </td>

                            <!-- العمود الأيسر (المستلم) -->
                            <td class="footer-cell">
                                <div class="line-wrapper"><span class="label">المستلم:</span><span class="line"></span></div>
                                <div class="line-wrapper"><span class="sub-label">التوقيع:</span><span class="line"></span></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div><!-- نهاية .invoice-container -->
    </div><!-- نهاية .invoice-wrapper -->

</div><!-- نهاية .container-xxl -->

<!-- سكربت الطباعة البسيط -->
<script>
    function printInvoice() {
        window.print();
    }
</script>

{% endblock %}
